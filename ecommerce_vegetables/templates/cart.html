{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

  <h2 class="mb-4 text-center">üõí Your Shopping Cart</h2>

  {% if orders %}

  <div class="table-responsive">
    <table class="table table-hover shadow-sm align-middle text-center" id="cart-table">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th class="text-start">Product</th>
          <th>Price (‚Çπ)</th>
          <th>Quantity</th>
          <th>Subtotal (‚Çπ)</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        {% set grand_total = 0 %}
        {% for order in orders %}
          {% set p = products.get(order.product_id) %}
          {% if p %}
            {% set subtotal = p.price * order.quantity %}
            {% set grand_total = grand_total + subtotal %}

            <tr data-price="{{ p.price }}" data-order-id="{{ order.id }}">
              <td>{{ loop.index }}</td>
              <td class="text-start fw-semibold">{{ p.name }}</td>
              <td>‚Çπ{{ "%.2f"|format(p.price) }}</td>

              <!-- Quantity Controls -->
              <td>
                <div class="d-flex justify-content-center align-items-center gap-2 quantity-control">
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-minus"
                          {% if order.quantity <= 1 %}disabled{% endif %}>
                    ‚àí
                  </button>

                  <span class="fw-semibold quantity-value">{{ order.quantity }}</span>

                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-plus">
                    +
                  </button>
                </div>
              </td>

              <!-- Subtotal -->
              <td class="product-total fw-semibold">
                ‚Çπ{{ "%.2f"|format(subtotal) }}
              </td>

              <!-- Remove -->
              <td>
                <form action="{{ url_for('remove_from_cart', id=order.id) }}" method="POST">
                  <button class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>

      <tfoot class="table-light">
        <tr>
          <th colspan="4" class="text-end fs-5">Grand Total:</th>
          <th colspan="2" class="fs-5 text-success" id="grand-total">
            ‚Çπ{{ "%.2f"|format(grand_total) }}
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Buttons -->
  <div class="d-flex justify-content-between mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
      ‚Üê Continue Shopping
    </a>
    <a href="{{ url_for('checkout') }}" class="btn btn-success btn-lg">
      Proceed to Checkout ‚Üí
    </a>
  </div>

  {% else %}
  <!-- Empty Cart -->
  <div class="alert alert-info text-center p-5 shadow-sm">
    <h4 class="mb-3">üõçÔ∏è Your cart is empty</h4>
    <p>Add some fresh products to your cart.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary mt-2">Shop Now</a>
  </div>
  {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const cartTable = document.getElementById("cart-table");
  const grandTotalEl = document.getElementById("grand-total");

  if (!cartTable) return;

  const updateTotals = () => {
    let grandTotal = 0;

    cartTable.querySelectorAll("tbody tr").forEach(row => {
      const price = parseFloat(row.dataset.price);
      const qty = parseInt(row.querySelector(".quantity-value").textContent);
      const total = price * qty;

      row.querySelector(".product-total").textContent = "‚Çπ" + total.toFixed(2);
      grandTotal += total;

      const minusBtn = row.querySelector(".btn-minus");
      minusBtn.disabled = qty <= 1;
    });

    grandTotalEl.textContent = "‚Çπ" + grandTotal.toFixed(2);
  };

  cartTable.querySelectorAll(".quantity-control").forEach(control => {
    const row = control.closest("tr");
    const orderId = row.dataset.orderId;
    const qtyEl = control.querySelector(".quantity-value");
    const minus = control.querySelector(".btn-minus");
    const plus = control.querySelector(".btn-plus");

    const updateServer = (action) => {
      fetch(`/update_cart/${orderId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: `action=${action}`
      })
      .then(() => {
        let qty = parseInt(qtyEl.textContent);
        qtyEl.textContent = action === "increase" ? qty + 1 : Math.max(1, qty - 1);
        updateTotals();
      });
    };

    minus.addEventListener("click", () => updateServer("decrease"));
    plus.addEventListener("click", () => updateServer("increase"));
  });

  updateTotals();
});
</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.getElementById("pay-btn")?.addEventListener("click", function () {

  fetch("/create-razorpay-order")
    .then(res => res.json())
    .then(data => {

      var options = {
        "key": data.key,
        "amount": data.amount * 100,
        "currency": "INR",
        "name": "VegStore",
        "description": "Fresh Vegetable Order",
        "order_id": data.order_id,

        "handler": function (response) {
          fetch("/payment-success", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body:
              "razorpay_payment_id=" + response.razorpay_payment_id
          })
          .then(() => {
            window.location.href = "/my-orders";
          });
        },

        "method": {
          "upi": true
        },

        "theme": {
          "color": "#28a745"
        }
      };

      var rzp = new Razorpay(options);
      rzp.open();
    });
});
</script>

{% endblock %}
